// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// User Management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  phone     String?
  password  String?
  role      UserRole @default(USER)
  avatar    String?
  isActive  Boolean  @default(true)
  
  // MFA Support
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?   // TOTP secret
  mfaBackupCodes Json? // Backup codes for MFA
  emailVerified Boolean   @default(false)
  phoneVerified  Boolean   @default(false)
  
  // Stripe Connect (for property owners)
  stripeAccountId     String? // Stripe Connect account ID
  stripeAccountStatus String? // pending, active, restricted
  
  // Preferences
  preferredCurrency String? @default("EUR")
  preferredLanguage String? @default("en")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties     Property[]
  bookings       Booking[]
  reviews        Review[]
  notifications  Notification[]
  messages       Message[]
  auditLogs      AuditLog[]
  propertyGroups PropertyGroup[]
  rooms          Room[]
  cleaningSchedules CleaningSchedule[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  PROPERTY_OWNER
  MANAGER
}

// Properties
model Property {
  id          String        @id @default(uuid())
  titleGr     String
  titleEn     String
  descriptionGr String?
  descriptionEn String?
  type        PropertyType
  status      PropertyStatus @default(ACTIVE)
  
  // Location (Preveza focus)
  address     String
  city        String        @default("Preveza")
  country     String        @default("Greece")
  latitude    Float?
  longitude   Float?
  postalCode  String?
  
  // Capacity
  maxGuests   Int
  bedrooms    Int
  bathrooms   Int
  area        Float? // in square meters
  
  // Pricing
  basePrice   Float
  currency    String        @default("EUR")
  cleaningFee Float?
  serviceFeePercentage Float? @default(10) // Platform fee percentage
  taxes       Float?
  taxRate     Float?        @default(24) // VAT rate for Greece
  
  // Availability
  minStay     Int           @default(1)
  maxStay     Int?
  advanceBooking Int        @default(30) // days
  
  // Rules
  checkInTime     String?
  checkOutTime    String?
  cancellationPolicy CancellationPolicy @default(FLEXIBLE)
  houseRules      String?
  petFriendly     Boolean   @default(false)
  smokingAllowed  Boolean   @default(false)
  partyAllowed    Boolean   @default(false)
  
  // Dynamic Rooms Support
  hasDynamicRooms Boolean   @default(false)
  
  // Cleanliness Tracking
  averageCleanlinessRating Float?
  lastCleaningDate        DateTime?
  
  // Property Group (Subholding)
  propertyGroupId String?  
  // Media
  images      Json? // Array of image URLs
  videos      Json? // Array of video URLs
  
  // Relations
  ownerId     String
  owner       User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bookings    Booking[]
  reviews     Review[]
  amenities   PropertyAmenity[]
  availability PropertyAvailability[]
  maintenance MaintenanceRequest[]
  rooms       Room[]
  notes       PropertyNote[]
  analytics   PropertyAnalytics[]
  cleaningSchedules CleaningSchedule[]
  propertyGroup PropertyGroup? @relation(fields: [propertyGroupId], references: [id], onDelete: SetNull)
  payments    Payment[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("properties")
}

enum PropertyType {
  APARTMENT
  HOUSE
  ROOM
  COMMERCIAL
  STORAGE
  PLOT
  GARAGE
  LUXURY
  INVESTMENT
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  SUSPENDED
}

enum CancellationPolicy {
  FLEXIBLE      // Full refund 24h before check-in
  MODERATE      // Full refund 5 days before check-in
  STRICT        // 50% refund 7 days before check-in
  SUPER_STRICT  // No refund
}

// Amenities
model Amenity {
  id          String   @id @default(uuid())
  nameGr      String
  nameEn      String
  icon        String?
  category    String
  createdAt   DateTime @default(now())

  // Relations
  properties  PropertyAmenity[]

  @@map("amenities")
}

model PropertyAmenity {
  id         String   @id @default(uuid())
  propertyId String
  amenityId  String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@unique([propertyId, amenityId])
  @@map("property_amenities")
}

// Bookings
model Booking {
  id              String        @id @default(uuid())
  propertyId      String
  guestId         String
  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Dates
  checkIn         DateTime
  checkOut        DateTime
  guests          Int
  
  // Pricing (Stay-only payment model)
  totalPrice      Float
  basePrice       Float
  cleaningFee     Float?
  serviceFee      Float?
  taxes           Float?
  currency        String        @default("EUR")
  ownerRevenue    Float?        // Revenue after platform fees
  platformFee    Float?        // Platform fee amount
  
  // Third-party / External booking info
  source          BookingSource @default(DIRECT)
  externalId      String?       // Booking ID from external platform (e.g. Booking.com confirmation #)
  externalPlatform String?      // Platform name if source is OTHER
  externalData    Json?         // Raw data from external platform for reference
  commissionRate  Float?        // Commission percentage charged by external platform
  commissionAmount Float?       // Calculated commission amount
  netRevenue      Float?        // Revenue after external platform commission
  externalGuestId String?       // Guest ID on external platform
  iCalUid         String?       // iCal UID for calendar sync
  lastSyncedAt    DateTime?     // Last time this booking was synced with external platform
  
  // Room Info (for hotel bookings with dynamic rooms)
  roomId          String?
  roomName        String?
  
  // Guest Info
  guestName       String
  guestEmail      String
  guestPhone      String?
  specialRequests String?
  
  // Relations
  property        Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  guest           User          @relation(fields: [guestId], references: [id], onDelete: Cascade)
  payments        Payment[]
  reviews         Review[]
  messages        Message[]
  maintenance     MaintenanceRequest[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([source, externalId]) // Prevent duplicate imports from same platform
  @@index([source])
  @@index([externalId])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingSource {
  DIRECT        // Booked through Stefanos website
  BOOKING_COM   // Booking.com
  AIRBNB        // Airbnb
  VRBO          // VRBO / HomeAway
  EXPEDIA       // Expedia
  MANUAL        // Manually entered by admin/owner
  OTHER         // Other third-party platform
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// Property Availability
model PropertyAvailability {
  id          String   @id @default(uuid())
  propertyId  String
  date        DateTime
  available   Boolean  @default(true)
  price       Float?
  minStay     Int?
  
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([propertyId, date])
  @@map("property_availability")
}

// Reviews
model Review {
  id          String   @id @default(uuid())
  propertyId  String
  bookingId   String
  guestId     String
  rating      Int      // 1-5 overall rating
  cleanlinessRating Int? // 1-5 cleanliness rating (required per requirements)
  accuracyRating     Int? // 1-5
  communicationRating Int? // 1-5
  locationRating     Int? // 1-5
  valueRating        Int? // 1-5
  title       String?
  comment     String?
  response    String?  // Host response
  isPublic    Boolean  @default(true)
  
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  guest       User     @relation(fields: [guestId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([bookingId])
  @@map("reviews")
}

// Maintenance Requests
model MaintenanceRequest {
  id          String              @id @default(uuid())
  propertyId  String
  bookingId   String?
  title       String
  description String
  priority    MaintenancePriority @default(MEDIUM)
  status      MaintenanceStatus   @default(OPEN)
  assignedTo  String?
  completedAt DateTime?
  
  property    Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  booking     Booking?            @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("maintenance_requests")
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Messages
model Message {
  id        String      @id @default(uuid())
  bookingId String
  senderId  String
  content   String
  type      MessageType @default(TEXT)
  isRead    Boolean     @default(false)
  
  booking   Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User        @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  createdAt DateTime    @default(now())

  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

// Notifications
model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?            // Additional data
  
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime         @default(now())

  @@map("notifications")
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  MAINTENANCE_REQUEST
  REVIEW_RECEIVED
  MESSAGE_RECEIVED
  SYSTEM_UPDATE
}

// Editions/Content Management
model Edition {
  id          String        @id @default(uuid())
  category    String
  titleGr     String
  titleEn     String
  descriptionGr String?
  descriptionEn String?
  contentGr   String?
  contentEn   String?
  status      ContentStatus @default(DRAFT)
  featured    Boolean       @default(false)
  order       Int?
  icon        String?       // Icon URL for category display
  color       String?       // Color for category display (blue, green, purple, orange, gray)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("editions")
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Services
model Service {
  id          String   @id @default(uuid())
  titleGr     String
  titleEn     String
  descriptionGr String?
  descriptionEn String?
  icon        String?
  features    Json? // Array of service features
  pricingGr   String?
  pricingEn   String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("services")
}

// Knowledge Articles
model KnowledgeArticle {
  id          String   @id @default(uuid())
  titleGr     String
  titleEn     String
  contentGr   String?
  contentEn   String?
  category    String
  tags        Json? // Array of article tags
  author      String
  readTime    Int?     // minutes
  publishedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("knowledge_articles")
}

// Payment Model (Separate from Booking for stay-only payment)
model Payment {
  id                  String        @id @default(uuid())
  bookingId           String
  propertyId          String
  amount              Float
  currency            String        @default("EUR")
  status              PaymentStatus  @default(PENDING)
  method              PaymentMethod
  transactionId       String?       // Internal transaction ID
  stripePaymentIntentId String?     // Stripe Payment Intent ID
  stripeChargeId      String?       // Stripe Charge ID
  refundAmount        Float?
  refundReason        String?
  refundedAt          DateTime?
  
  // Payout Information (Stripe Connect)
  payoutId            String?       // Stripe Payout ID
  payoutStatus        String?       // pending, paid, failed
  payoutScheduledFor DateTime?
  
  processedAt         DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Relations
  booking             Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  property            Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  APPLE_PAY
  GOOGLE_PAY
  PAYPAL
  BANK_TRANSFER
  STRIPE_LINK
}

// Room Model (Dynamic Rooms)
model Room {
  id          String   @id @default(uuid())
  propertyId  String
  name        String
  nameGr      String?
  nameEn      String?
  type        RoomType
  capacity    Int
  maxAdults   Int?
  maxChildren Int?
  maxInfants  Int?
  basePrice   Float
  isBookable  Boolean  @default(true)
  amenities   Json? // Array of amenity IDs
  images      Json? // Array of room images
  descriptionGr String?
  descriptionEn String?

  // Relations
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId     String

  // New relations for content management
  roomContent RoomContent?
  availabilityRules RoomAvailabilityRule[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("rooms")
}

enum RoomType {
  BEDROOM
  LIVING_ROOM
  STUDIO
  KITCHEN
  BATHROOM
  BALCONY
  TERRACE
  GARDEN
  OTHER
}

// Property Group (Subholding)
model PropertyGroup {
  id          String   @id @default(uuid())
  name        String
  nameGr      String?
  nameEn      String?
  description String?
  ownerId     String   
  // Relations
  owner       User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  properties  Property[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("property_groups")
}

// Cleaning Schedule
model CleaningSchedule {
  id          String   @id @default(uuid())
  propertyId  String
  frequency   CleaningFrequency
  lastCleaned DateTime?
  nextCleaning DateTime?
  assignedCleaner String? // User ID or external cleaner
  ownerId     String
  notes       String?
  
  // Relations
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("cleaning_schedules")
}

enum CleaningFrequency {
  AFTER_EACH_BOOKING
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

// Property Analytics
model PropertyAnalytics {
  id          String   @id @default(uuid())
  propertyId  String
  period      AnalyticsPeriod
  periodStart DateTime
  periodEnd   DateTime
  
  // Revenue Metrics
  totalRevenue        Float
  totalCosts          Float
  cleaningCosts       Float
  maintenanceCosts    Float
  platformFees        Float
  netProfit           Float
  profitMargin        Float // percentage
  
  // Booking Metrics
  totalBookings       Int
  cancelledBookings   Int
  occupancyRate       Float // percentage
  averageDailyRate    Float
  revenuePerAvailableRoom Float?
  
  // Guest Metrics
  averageRating       Float?
  averageCleanlinessRating Float?
  totalReviews        Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([propertyId, period, periodStart])
  @@map("property_analytics")
}

enum AnalyticsPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

// Property Notes
model PropertyNote {
  id          String   @id @default(uuid())
  propertyId  String
  type        NoteType
  title       String
  content     String
  isPrivate   Boolean  @default(true) // Owner-only vs admin-visible
  createdBy   String  // User ID
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@map("property_notes")
}

enum NoteType {
  OWNER_NOTE
  MAINTENANCE_NOTE
  GUEST_PREFERENCE
  BUSINESS_NOTE
  ADMIN_NOTE
}

// Audit Log
model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType  String   // Property, Booking, User, etc.
  entityId    String?
  changes     Json?    // Before/after changes
  ipAddress   String?
  userAgent   String?
  metadata    Json?

  createdAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// Content Management System
model Content {
  id            String        @id @default(uuid())
  page          String        // homepage, about, dining, facilities, contact, privacy, terms
  section       String        // hero, featured_rooms, highlights, testimonials, gallery, seo
  key           String        // Unique identifier within page/section
  contentGr     String?       // Greek content
  contentEn     String?       // English content
  type          ContentType   @default(TEXT)
  order         Int           @default(0)
  active        Boolean       @default(true)
  metadata      Json?         // Additional structured data (JSON)

  // SEO fields
  metaTitleGr   String?
  metaTitleEn   String?
  metaDescriptionGr String?
  metaDescriptionEn String?
  keywords      Json?         // Array of keywords

  // Relations
  media         ContentMedia[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([page, section, key])
  @@index([page])
  @@index([section])
  @@index([active])
  @@map("content")
}

enum ContentType {
  TEXT
  HTML
  MARKDOWN
  JSON
  IMAGE
  GALLERY
  HERO
}

// Content-Media junction table
model ContentMedia {
  id          String   @id @default(uuid())
  contentId   String
  mediaId     String
  order       Int      @default(0)

  content     Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  media       Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([contentId, mediaId])
  @@map("content_media")
}

// Media Library
model Media {
  id          String   @id @default(uuid())
  filename    String
  originalName String
  url         String
  thumbnailUrl String?
  category    MediaCategory @default(GENERAL)
  altTextGr   String?
  altTextEn   String?
  mimeType    String
  size        Int        // File size in bytes
  width       Int?
  height      Int?

  // Relations
  content     ContentMedia[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([category])
  @@index([createdAt])
  @@map("media")
}

enum MediaCategory {
  ROOMS
  COMMON_AREAS
  AMENITIES
  GALLERY
  HERO
  LOGO
  GENERAL
}

// Settings / Configuration
model Setting {
  id          String       @id @default(uuid())
  key         String       @unique
  value       String
  type        SettingType  @default(STRING)
  group       String       @default("general") // general, booking, seo, social, email
  description String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([group])
  @@map("settings")
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// Room Content Enhancement (additional room details)
model RoomContent {
  id              String   @id @default(uuid())
  roomId          String   @unique
  room            Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Enhanced content
  highlightsGr    String?  // Room highlights/bullet points
  highlightsEn  String?
  featuresGr      Json?    // Array of features
  featuresEn      Json?
  virtualTourUrl  String?
  floorPlanUrl    String?

  // SEO
  metaTitleGr     String?
  metaTitleEn     String?
  metaDescriptionGr String?
  metaDescriptionEn String?

  // Room Amenities with descriptions
  amenitiesDetails Json?  // Detailed amenity descriptions

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("room_content")
}

// Room Availability Rules
model RoomAvailabilityRule {
  id              String   @id @default(uuid())
  roomId          String
  room            Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  startDate       DateTime
  endDate         DateTime
  isAvailable     Boolean  @default(true)
  reason          String?  // maintenance, holiday, etc.

  // Pricing override
  priceOverride   Float?
  minStayOverride Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("room_availability_rules")
}
